<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/admin/css/style.css">
    <title>ubig-admin</title>
</head>

<body>
    <h4>ubig admin</h4>
    <button id="add">添加</button>
    <ul class="album">

    </ul>

    <div class="model">
        <ul class="preview">
            <li>
                <label>
                    上传照片
                    <img src="" class="photo-preview">
                    <input type="file" name="files" class="photo">
                    <input type="text" class="note">
                </label>
            </li>
        </ul>
        <a id="addNewPhoto">添加照片</a>
        <input type="month" id="date">
        <input type="text" id="title">
        <button id="sc">sc</button>
    </div>
</body>
<script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script>
    $('#addNewPhoto').click(function () {
        $('.preview').append('<li>\
                <label>\
                    上传照片\
                    <img src="" class="photo-preview">\
                    <input type="file" name="files" class="photo">\
                    <input type="text" class="note">\
                </label>\
            </li>')
    })
    $('body').on('change', '.photo', function () {
        var _this = $(this)
        var obj = _this.get(0).files[0];
        console.log(obj);
        var fr = new FileReader();
        fr.onload = function () {
            _this.siblings('img').attr('src', this.result);
        };
        fr.readAsDataURL(obj);
    })
    $('#sc').click(function () {

        var formData = new FormData();
        var album = [];
        $('.preview li').each(function(){
            var image = $(this).find('.photo').get(0).files[0];
            album.push({photo: image.name, note: $(this).find('.note').val()})
            formData.append('files', image)
        })
        formData.append('album', JSON.stringify(album))
        formData.append('year', $('#date').val().split('-')[0])
        formData.append('month', $('#date').val().split('-')[1])
        formData.append('title', $('#title').val())
        $.ajax({
            url: '/admin/up/photos',
            type: 'post',
            data: formData,
            processData: false,
            contentType: false,
            success: function (data) {
                console.log(data);
            }
        });
    })

    $.ajax({
        url: '/admin/photos',
        type: 'get',
        success: function (data) {
            data.forEach(function (album) {

                $('.album').append(
                    '<li class="item">\
                        <a href="/admin/album?year=' + album.year + '&month=' + album.month + '&title=' + album.title + '">\
                            <div class="cover">\
                                <img src="/photos/' + album.year + '/' + album.month + '/' + album.title + '/' + album.thumb + '" alt="">\
                            </div>\
                            <h5 class="title"></h5>\
                        </a>\
                    </li>')
            })

            console.log(data)
        }
    })
</script>

</html>